{% extends "base.html" %}

{% block title %}IRIS &mdash; Results{% endblock %}

{% block content %}

{% if streaming %}
{# ================================================================
   STREAMING MODE — skeleton page + SSE progressive rendering
   ================================================================ #}

<!-- Score Banner (loading state) -->
<section class="score-banner score-pending" id="score-banner">
    <div class="score-value" id="score-value">
        <div class="spinner-ring-sm"></div>
    </div>
    <div class="score-label" id="score-label">Scanning&hellip;</div>
    <div class="score-url" id="score-url"></div>
</section>

<!-- Recommendation (hidden until score arrives) -->
<section class="recommendation rec-pending" id="recommendation" style="display:none;">
    <p id="recommendation-text"></p>
</section>

<!-- Action buttons at top -->
<div class="actions">
    <a href="/" class="btn btn-primary">New Scan</a>
    <button type="button" class="btn btn-secondary" id="copy-report-btn"
            style="display:none;" onclick="copyReport()">Copy Report</button>
    {% if bulk_id %}
    <a href="/bulk?id={{ bulk_id }}" class="btn btn-secondary">Back to Bulk Scan</a>
    {% endif %}
</div>

<!-- Screenshot -->
<section class="card" id="section-screenshot">
    <details open>
        <summary class="section-toggle">Page Screenshot</summary>
        <div class="section-body" id="screenshot-body">
            <div class="skeleton-loading">Capturing screenshot&hellip;</div>
        </div>
    </details>
</section>

<!-- Redirect Chain (hidden until data) -->
<section class="card" id="section-redirect" style="display:none;">
    <details open>
        <summary class="section-toggle">Redirect Chain</summary>
        <div class="section-body" id="redirect-body"></div>
    </details>
</section>

<!-- URL Threat Feed Results (hidden until data) -->
<section class="card" id="section-feeds" style="display:none;">
    <details open>
        <summary class="section-toggle">URL Threat Feed Results</summary>
        <div class="section-body" id="feeds-body"></div>
    </details>
</section>

<!-- File Download Analysis (hidden until data) -->
<section class="card" id="section-download" style="display:none;">
    <details open>
        <summary class="section-toggle">File Download Analysis</summary>
        <div class="section-body" id="download-body"></div>
    </details>
</section>

<!-- Link Discovery (hidden until data) -->
<section class="card" id="section-links" style="display:none;">
    <details open>
        <summary class="section-toggle">Link Discovery</summary>
        <div class="section-body" id="links-body"></div>
    </details>
</section>

<!-- OSINT Links (hidden until data) -->
<section class="card" id="section-osint" style="display:none;">
    <details open>
        <summary class="section-toggle">OSINT Links</summary>
        <div class="section-body" id="osint-body"></div>
    </details>
</section>

<!-- Multi-Screenshots (hidden until data) -->
<section class="card" id="section-multi-screenshots" style="display:none;">
    <details open>
        <summary class="section-toggle">Screenshots (Initial &amp; CTA Click)</summary>
        <div class="section-body" id="multi-screenshots-body"></div>
    </details>
</section>

<!-- SOC Workflow (hidden until scan complete) -->
<section class="card escalation-section" id="section-soc-workflow" style="display:none;">
    <details open>
        <summary class="section-toggle">SOC Workflow</summary>
        <div class="section-body">
            <h4 style="margin:0 0 0.5rem;font-size:0.92rem;">Alert Context <span class="muted" style="font-weight:400;font-size:0.78rem;">(optional)</span></h4>
            <div class="alert-context-panel">
                <div class="alert-context-grid">
                    <div class="alert-context-field">
                        <label class="alert-context-label">UPN / Email</label>
                        <input type="text" class="alert-context-input" id="ctx-upn" placeholder="user@contoso.com">
                    </div>
                    <div class="alert-context-field">
                        <label class="alert-context-label">Display Name</label>
                        <input type="text" class="alert-context-input" id="ctx-name" placeholder="John Doe">
                    </div>
                    <div class="alert-context-field">
                        <label class="alert-context-label">Subject</label>
                        <input type="text" class="alert-context-input" id="ctx-subject" placeholder="Email subject line">
                    </div>
                    <div class="alert-context-field">
                        <label class="alert-context-label">Network Message ID</label>
                        <input type="text" class="alert-context-input" id="ctx-msgid" placeholder="Message ID from alert">
                    </div>
                    <div class="alert-context-field">
                        <label class="alert-context-label">Sender</label>
                        <input type="text" class="alert-context-input" id="ctx-sender" placeholder="sender@malicious.com">
                    </div>
                    <div class="alert-context-field">
                        <label class="alert-context-label">Sender IP</label>
                        <input type="text" class="alert-context-input" id="ctx-sender-ip" placeholder="1.2.3.4">
                    </div>
                    <div class="alert-context-field full-width">
                        <label class="alert-context-label">Alert Name</label>
                        <input type="text" class="alert-context-input" id="ctx-alert-name" placeholder="e.g. Phishing URL Click">
                    </div>
                </div>
                <div class="alert-context-actions">
                    <button type="button" class="btn btn-primary btn-sm" id="btn-generate-escalation" onclick="generateEscalation()">Generate Escalation</button>
                    <button type="button" class="btn btn-secondary btn-sm" id="btn-enrich-ip" onclick="enrichSenderIp()" style="display:none;">Enrich Sender IP</button>
                </div>
            </div>
            <div id="sender-ip-results" class="sender-ip-results" style="display:none;"></div>
            <div id="kql-section" style="display:none;margin-top:1.25rem;">
                <h4 style="margin:0 0 0.5rem;font-size:0.92rem;">KQL Queries</h4>
                <div class="kql-grid" id="kql-grid"></div>
            </div>
            <div id="escalation-section" style="display:none;margin-top:1.25rem;">
                <h4 style="margin:0 0 0.5rem;font-size:0.92rem;">Escalation</h4>
                <div class="escalation-output">
                    <pre id="escalation-output-pre"></pre>
                </div>
                <div class="escalation-actions">
                    <button type="button" class="btn btn-primary btn-sm" onclick="copyEscalation()">Copy Escalation</button>
                </div>
            </div>
        </div>
    </details>
</section>

<!-- Analyzer Breakdown -->
<section class="card" id="section-analyzers">
    <details>
        <summary class="section-toggle">Analyzer Breakdown</summary>
        <div class="section-body">
            <table class="table table--fixed">
                <colgroup>
                    <col style="width:55%">
                    <col style="width:15%">
                    <col style="width:15%">
                    <col style="width:15%">
                </colgroup>
                <thead>
                    <tr>
                        <th>Analyzer</th>
                        <th>Status</th>
                        <th>Score</th>
                        <th>Weight</th>
                    </tr>
                </thead>
                <tbody id="analyzer-tbody">
                    <!-- Rows added dynamically by SSE -->
                </tbody>
            </table>
            <div class="skeleton-loading" id="analyzers-loading">Running analyzers&hellip;</div>
        </div>
    </details>
</section>

<!-- Scan Metadata -->
<section class="card" id="section-metadata">
    <details>
        <summary class="section-toggle">Scan Metadata</summary>
        <div class="section-body meta-content" id="metadata-content">
            <div class="skeleton-loading">Loading&hellip;</div>
        </div>
    </details>
</section>

<script>
(function () {
    "use strict";

    var scanId = "{{ scan_id }}";
    var es = new EventSource("/stream/" + scanId);

    /* ---- Report data accumulator for Copy Report ---- */
    var _reportData = {
        url: "", defangedUrl: "", riskCategory: "", confidence: 0,
        timestamp: "", ip: "", domain: "", recommendation: "",
        redirectChain: [], feedResults: [], findings: [], fileDownload: null
    };

    /* ---- Helper: escape HTML entities ---- */
    function esc(s) {
        var el = document.createElement("span");
        el.textContent = s || "";
        return el.innerHTML;
    }

    /* ---- Helper: defang a URL for safe display ---- */
    function defang(url) {
        if (!url) return "";
        var s = url;
        s = s.replace(/^https:\/\//i, "hxxps://");
        s = s.replace(/^http:\/\//i, "hxxp://");
        s = s.replace(/^ftp:\/\//i, "fxp://");
        var match = s.match(/^(hxxps?:\/\/|fxp:\/\/)/i);
        if (match) {
            var after = s.substring(match[0].length);
            var slashIdx = after.indexOf("/");
            if (slashIdx === -1) {
                s = match[0] + after.replace(/\./g, "[.]");
            } else {
                var domain = after.substring(0, slashIdx);
                var path = after.substring(slashIdx);
                s = match[0] + domain.replace(/\./g, "[.]") + path;
            }
        } else {
            var slashIdx = s.indexOf("/");
            if (slashIdx === -1) {
                s = s.replace(/\./g, "[.]");
            } else {
                var domain = s.substring(0, slashIdx);
                var path = s.substring(slashIdx);
                s = domain.replace(/\./g, "[.]") + path;
            }
        }
        return s;
    }

    /* ---- Helper: inline copy button HTML ---- */
    function copyBtnHtml(text) {
        var el = document.createElement("span");
        el.textContent = text;
        var encoded = el.innerHTML.replace(/"/g, "&quot;");
        return '<button class="copy-chip" data-copy="' + encoded + '" title="Copy">&#128203;</button>';
    }

    /* ---- already_complete: redirect to static results ---- */
    es.addEventListener("already_complete", function () {
        es.close();
        window.location.href = "/results/" + scanId;
    });

    /* ---- metadata ---- */
    es.addEventListener("metadata", function (e) {
        var d = JSON.parse(e.data);
        document.getElementById("score-url").textContent = defang(d.url || "");
        var html = "<p><strong>Scan ID:</strong> " + esc(d.scan_id) + "</p>" +
            "<p><strong>Domain:</strong> " + esc(d.domain) + "</p>" +
            (d.ip ? "<p><strong>Resolved IP:</strong> " + esc(d.ip) + "</p>" : "");
        document.getElementById("metadata-content").innerHTML = html;

        _reportData.url = d.url || "";
        _reportData.defangedUrl = defang(d.url || "");
        _reportData.domain = d.domain || "";
        _reportData.ip = d.ip || "";
        _reportData.timestamp = new Date().toISOString();
    });

    /* ---- osint ---- */
    es.addEventListener("osint", function (e) {
        var d = JSON.parse(e.data);
        if (d.links && d.links.length) {
            document.getElementById("section-osint").style.display = "";
            var html = '<div class="osint-grid">';
            d.links.forEach(function (link) {
                html += '<a href="' + esc(link.url) + '" target="_blank" rel="noopener noreferrer"' +
                    ' class="osint-link osint-' + esc(link.icon_class) + '">' +
                    '<span class="osint-name">' + esc(link.name) + '</span>' +
                    '<span class="osint-desc">' + esc(link.description) + '</span></a>';
            });
            html += '</div>';
            document.getElementById("osint-body").innerHTML = html;
        }
    });

    /* ---- analyzer ---- */
    es.addEventListener("analyzer", function (e) {
        var d = JSON.parse(e.data);
        var r = d.result;
        var loadingEl = document.getElementById("analyzers-loading");
        if (loadingEl) loadingEl.remove();

        var tbody = document.getElementById("analyzer-tbody");
        var tr = document.createElement("tr");

        /* Build findings list (sorted: critical → info) */
        var sevOrder = {critical: 0, high: 1, medium: 2, low: 3, info: 4};
        var findingsHtml = "";
        if (r.findings && r.findings.length) {
            var sorted = r.findings.slice().sort(function (a, b) {
                return (sevOrder[a.severity] || 5) - (sevOrder[b.severity] || 5);
            });
            findingsHtml = '<ul class="findings-list">';
            sorted.forEach(function (f) {
                findingsHtml += '<li onclick="this.classList.toggle(\'expanded\')"><span class="severity severity-' + esc(f.severity) + '">' +
                    esc(f.severity) + '</span> ' + esc(f.description) +
                    ' (+' + Math.round(f.score_contribution) + ')</li>';
            });
            findingsHtml += '</ul>';
        } else if (r.error_message) {
            findingsHtml = '<p class="error-message">' + esc(r.error_message) + '</p>';
        } else {
            findingsHtml = '<p class="muted">No findings.</p>';
        }

        tr.innerHTML =
            '<td><details><summary>' + esc(r.analyzer_name) + '</summary>' + findingsHtml + '</details></td>' +
            '<td><span class="badge badge-status-' + esc(r.status.toLowerCase()) + '">' + esc(r.status) + '</span></td>' +
            '<td>' + r.score.toFixed(1) + '</td>' +
            '<td>' + Math.round(r.max_weight) + '</td>';
        tbody.appendChild(tr);

        /* Accumulate findings for Copy Report */
        if (r.status === "COMPLETED" && r.findings) {
            r.findings.forEach(function (f) {
                _reportData.findings.push({
                    severity: f.severity,
                    description: f.description,
                    score: f.score_contribution
                });
            });
        }

        /* If this is Link Discovery, also render the discovered links section */
        if (r.analyzer_name === "Link Discovery Analysis" && r.findings) {
            /* Link discovery data comes via a separate event — handled below */
        }
    });

    /* ---- screenshot ---- */
    es.addEventListener("screenshot", function (e) {
        var d = JSON.parse(e.data);
        var body = document.getElementById("screenshot-body");
        if (d.filename) {
            body.innerHTML = '<div class="screenshot-wrapper">' +
                '<img src="/screenshots/' + esc(d.filename) + '" alt="Screenshot" class="screenshot-img">' +
                '</div>';
        } else {
            body.innerHTML = '<div class="screenshot-unavailable">' +
                '<div class="screenshot-unavailable-icon">&#128247;</div>' +
                '<p>Screenshot unavailable</p>' +
                '<p class="muted">The site blocked the capture or the connection timed out.</p></div>';
        }
    });

    /* ---- feed_results ---- */
    es.addEventListener("feed_results", function (e) {
        var d = JSON.parse(e.data);
        if (!d.feeds || !d.feeds.length) return;
        document.getElementById("section-feeds").style.display = "";

        /* Sort: matched first, then by display_order */
        var feeds = d.feeds.slice().sort(function (a, b) {
            if (b.matched !== a.matched) return b.matched ? 1 : -1;
            return (a.display_order || 99) - (b.display_order || 99);
        });

        var html = '<table class="table"><thead><tr><th>Feed</th><th>Match</th><th>Details</th></tr></thead><tbody>';
        feeds.forEach(function (f) {
            var cls = f.matched ? ' class="feed-match"' : '';
            var badge = f.matched
                ? '<span class="badge badge-malicious">MATCH</span>'
                : '<span class="badge badge-status-skipped">Not Found</span>';
            html += '<tr' + cls + '><td>' + esc(f.feed_name) + '</td><td>' + badge + '</td>' +
                '<td>' + esc(f.details || "\u2014") + '</td></tr>';
        });
        html += '</tbody></table>';
        document.getElementById("feeds-body").innerHTML = html;

        _reportData.feedResults = d.feeds.map(function (f) {
            return {feed_name: f.feed_name, matched: f.matched, details: f.details || ""};
        });
    });

    /* ---- file_download ---- */
    es.addEventListener("file_download", function (e) {
        var d = JSON.parse(e.data);
        if (!d.info || !d.info.detected) return;
        var info = d.info;
        document.getElementById("section-download").style.display = "";

        var html = '<div class="file-dl-stack">';
        /* Filename */
        html += '<div class="file-dl-filename">';
        if (info.filename) {
            html += '<span class="file-dl-filename-label">File name:</span> ' + esc(info.filename) + copyBtnHtml(info.filename);
        } else {
            html += '<span class="muted" style="font-weight:400;">Unknown filename</span>';
        }
        if (info.extension) {
            html += ' <span class="flag flag-warning">' + esc(info.extension) + '</span>';
        }
        html += '</div>';

        /* Hash + VT */
        html += '<div class="file-dl-details">';
        if (info.sha1) {
            html += '<div class="file-dl-row"><span class="file-dl-key">SHA-1</span><span class="file-dl-val">';
            html += '<code class="hash-value">' + esc(info.sha1) + '</code>' + copyBtnHtml(info.sha1);
            html += '</span></div>';
        }
        html += '<div class="file-dl-row"><span class="file-dl-key">SHA-256</span><span class="file-dl-val">';
        if (info.sha256) {
            html += '<code class="hash-value">' + esc(info.sha256) + '</code>' + copyBtnHtml(info.sha256);
        } else {
            html += '<span class="muted">Could not compute hash</span>';
        }
        html += '</span></div>';

        html += '<div class="file-dl-row">';
        if (info.vt_link) {
            html += '<a href="' + esc(info.vt_link) + '" target="_blank" rel="noopener noreferrer" class="file-dl-key file-dl-key-link">VirusTotal</a>';
        } else {
            html += '<span class="file-dl-key">VirusTotal</span>';
        }
        html += '<span class="file-dl-val">';
        if (info.vt_total_engines > 0) {
            var badgeCls = info.vt_detections > 0 ? "badge-vt-malicious" : "badge-vt-clean";
            html += '<span class="badge ' + badgeCls + '">' + info.vt_detections + '/' + info.vt_total_engines + ' engines</span>';
            if (info.threat_category) html += ' <span class="badge badge-threat-category">' + esc(info.threat_category) + '</span>';
            if (info.popular_threat_label) html += ' <a href="https://www.google.com/search?q=%22' + encodeURIComponent(info.popular_threat_label) + '%22+malware+analysis" target="_blank" rel="noopener noreferrer" class="vt-threat-label" title="Search for ' + esc(info.popular_threat_label) + '">' + esc(info.popular_threat_label) + '</a>';
        } else if (info.vt_link) {
            html += '<span class="badge badge-vt-unknown">Not in database</span>';
        } else {
            html += '<span class="muted">No API key configured</span>';
        }
        html += '</span></div></div>';

        /* Meta row */
        html += '<div class="file-dl-meta">';
        html += '<span class="file-dl-meta-item"><span class="file-dl-meta-label">HOST:</span> <span class="file-dl-meta-value">' + esc(info.hosting_domain) + '</span>';
        if (info.is_abused_host) html += ' <span class="flag flag-critical">Abused CDN</span>';
        html += '</span>';
        if (info.content_type) html += '<span class="file-dl-meta-item"><span class="file-dl-meta-label">TYPE:</span> <span class="file-dl-meta-value">' + esc(info.content_type) + '</span></span>';
        if (info.size_bytes > 0) {
            var sz = info.size_bytes < 1024 ? info.size_bytes + " B"
                : info.size_bytes < 1048576 ? (info.size_bytes / 1024).toFixed(1) + " KB"
                : (info.size_bytes / 1048576).toFixed(1) + " MB";
            html += '<span class="file-dl-meta-item"><span class="file-dl-meta-label">SIZE:</span> <span class="file-dl-meta-value">' + sz + '</span></span>';
        }
        html += '</div></div>';

        document.getElementById("download-body").innerHTML = html;

        _reportData.fileDownload = {
            filename: info.filename || "",
            sha1: info.sha1 || "",
            sha256: info.sha256 || "",
            vt_detections: info.vt_detections || 0,
            vt_total_engines: info.vt_total_engines || 0,
            popular_threat_label: info.popular_threat_label || ""
        };
    });

    /* ---- redirect_chain ---- */
    es.addEventListener("redirect_chain", function (e) {
        var d = JSON.parse(e.data);
        if (!d.chain || !d.chain.length) return;
        document.getElementById("section-redirect").style.display = "";
        var html = '<div class="redirect-chain">';
        d.chain.forEach(function (hop, i) {
            html += '<span class="redirect-hop">' + esc(defang(hop)) + copyBtnHtml(hop) + '</span>';
            if (i < d.chain.length - 1) html += '<span class="redirect-arrow">&rarr;</span>';
        });
        html += '</div>';
        document.getElementById("redirect-body").innerHTML = html;

        _reportData.redirectChain = d.chain || [];
    });

    /* ---- score ---- */
    es.addEventListener("score", function (e) {
        var d = JSON.parse(e.data);
        /* Map risk category value to CSS class */
        var catMap = {
            "Safe": "safe",
            "Uncertain": "uncertain",
            "Malicious": "malicious",
            "Malicious File Download": "malicious_download",
            "Suspicious File Download": "suspicious_download"
        };
        var catClass = catMap[d.risk_category] || "safe";

        var banner = document.getElementById("score-banner");
        banner.className = "score-banner score-" + catClass;
        document.getElementById("score-value").textContent = d.risk_category;
        document.getElementById("score-label").textContent = d.confidence.toFixed(0) + "% Confidence";

        var rec = document.getElementById("recommendation");
        rec.style.display = "";
        rec.className = "recommendation rec-" + catClass;
        document.getElementById("recommendation-text").textContent = d.recommendation;

        _reportData.riskCategory = d.risk_category;
        _reportData.confidence = d.confidence;
        _reportData.recommendation = d.recommendation;
    });

    /* ---- multi_screenshots ---- */
    es.addEventListener("multi_screenshots", function (e) {
        var d = JSON.parse(e.data);
        if (!d.cta) return;  /* Only show when a CTA button was actually clicked */
        document.getElementById("section-multi-screenshots").style.display = "";
        var html = '<div class="multi-screenshot-grid">';
        if (d.initial) {
            html += '<div class="multi-screenshot-item">' +
                '<div class="multi-screenshot-label">Initial Page</div>';
            if (d.initial_url) html += '<div class="multi-screenshot-url">' + esc(defang(d.initial_url)) + '</div>';
            html += '<img src="/screenshots/' + esc(d.initial) + '" alt="Initial page" class="screenshot-img">' +
                '</div>';
        }
        if (d.cta) {
            html += '<div class="multi-screenshot-item">' +
                '<div class="multi-screenshot-label label-cta">After Click: ' + esc(d.cta_text || "CTA") + '</div>';
            if (d.cta_url) html += '<div class="multi-screenshot-url">' + esc(defang(d.cta_url)) + '</div>';
            html += '<img src="/screenshots/' + esc(d.cta) + '" alt="After CTA click" class="screenshot-img">' +
                '</div>';
        }
        html += '</div>';
        document.getElementById("multi-screenshots-body").innerHTML = html;
    });

    /* ---- complete ---- */
    es.addEventListener("complete", function () {
        es.close();
        /* Remove any leftover loading indicators */
        var loaders = document.querySelectorAll(".skeleton-loading");
        loaders.forEach(function (el) { el.remove(); });
        /* Show Copy Report button */
        var copyBtn = document.getElementById("copy-report-btn");
        if (copyBtn) copyBtn.style.display = "";
        /* Show SOC Workflow section (phishing only, not download verdicts) */
        var socSection = document.getElementById("section-soc-workflow");
        var isDownload = _reportData.riskCategory === "Malicious File Download" ||
                         _reportData.riskCategory === "Suspicious File Download";
        if (socSection && !isDownload) socSection.style.display = "";
    });

    /* ---- error ---- */
    es.addEventListener("error", function (e) {
        if (e.data) {
            es.close();
            var d = JSON.parse(e.data);
            alert("Scan error: " + (d.message || "Unknown error"));
        }
    });
    /* ---- Expose copyReport to global scope ---- */
    window.copyReport = function () {
        var d = _reportData;
        var lines = [];
        lines.push("=== IRIS Scan Report ===");
        lines.push("URL (defanged): " + d.defangedUrl);
        lines.push("Classification: " + d.riskCategory + " (" + d.confidence.toFixed(0) + "% confidence)");
        lines.push("Scanned: " + d.timestamp);
        if (d.ip) lines.push("Resolved IP: " + defang(d.ip));
        lines.push("Domain: " + d.domain);
        lines.push("");
        lines.push("--- Recommendation ---");
        lines.push(d.recommendation);

        if (d.feedResults.length) {
            lines.push("");
            lines.push("--- Threat Feed Results ---");
            d.feedResults.forEach(function (f) {
                var tag = f.matched ? "[MATCH]" : "[CLEAR]";
                lines.push(tag + " " + f.feed_name + ": " + (f.details || "No details"));
            });
        }

        if (d.redirectChain.length) {
            lines.push("");
            lines.push("--- Redirect Chain (" + d.redirectChain.length + " hops) ---");
            lines.push(d.redirectChain.map(function (h) { return defang(h); }).join(" -> "));
        }

        if (d.findings.length) {
            lines.push("");
            lines.push("--- Key Findings ---");
            var sevOrder = {critical: 0, high: 1, medium: 2, low: 3, info: 4};
            var sorted = d.findings.slice().sort(function (a, b) {
                return (sevOrder[a.severity] || 5) - (sevOrder[b.severity] || 5);
            });
            sorted.forEach(function (f) {
                lines.push("[" + f.severity.toUpperCase() + "] " + f.description + " (+" + Math.round(f.score) + ")");
            });
        }

        if (d.fileDownload) {
            lines.push("");
            lines.push("--- File Download ---");
            if (d.fileDownload.filename) lines.push("Filename: " + d.fileDownload.filename);
            if (d.fileDownload.sha1) lines.push("SHA-1: " + d.fileDownload.sha1);
            if (d.fileDownload.sha256) lines.push("SHA-256: " + d.fileDownload.sha256);
            if (d.fileDownload.vt_total_engines > 0) {
                var vtLine = "VirusTotal: " + d.fileDownload.vt_detections + "/" + d.fileDownload.vt_total_engines + " engines";
                if (d.fileDownload.popular_threat_label) vtLine += " (" + d.fileDownload.popular_threat_label + ")";
                lines.push(vtLine);
            }
        }

        lines.push("");
        lines.push("=== End IRIS Report ===");

        navigator.clipboard.writeText(lines.join("\n")).then(function () {
            var btn = document.getElementById("copy-report-btn");
            btn.textContent = "Copied!";
            setTimeout(function () { btn.textContent = "Copy Report"; }, 2000);
        });
    };

    /* ---- Show Enrich IP button when sender IP is entered ---- */
    var senderIpInput = document.getElementById("ctx-sender-ip");
    if (senderIpInput) {
        senderIpInput.addEventListener("input", function () {
            var btn = document.getElementById("btn-enrich-ip");
            btn.style.display = this.value.trim() ? "" : "none";
        });
    }

    /* ---- Generate Escalation (streaming mode) ---- */
    window.generateEscalation = function () {
        var btn = document.getElementById("btn-generate-escalation");
        btn.disabled = true;
        btn.textContent = "Generating\u2026";

        var alertCtx = {
            upn: (document.getElementById("ctx-upn").value || "").trim(),
            name: (document.getElementById("ctx-name").value || "").trim(),
            subject: (document.getElementById("ctx-subject").value || "").trim(),
            network_message_id: (document.getElementById("ctx-msgid").value || "").trim(),
            sender: (document.getElementById("ctx-sender").value || "").trim(),
            sender_ip: (document.getElementById("ctx-sender-ip").value || "").trim(),
            alert_name: (document.getElementById("ctx-alert-name").value || "").trim(),
        };
        var hasContext = false;
        Object.keys(alertCtx).forEach(function (k) {
            if (!alertCtx[k]) delete alertCtx[k];
            else hasContext = true;
        });

        fetch("/api/escalation/" + scanId, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({alert_context: hasContext ? alertCtx : null}),
        })
        .then(function (resp) { return resp.json(); })
        .then(function (data) {
            if (data.error) { alert("Error: " + data.error); return; }
            document.getElementById("escalation-section").style.display = "";
            document.getElementById("escalation-output-pre").textContent = data.escalation_md;
            if (data.kql_queries && data.kql_queries.length) {
                document.getElementById("kql-section").style.display = "";
                var grid = document.getElementById("kql-grid");
                grid.innerHTML = "";
                data.kql_queries.forEach(function (q) {
                    var card = document.createElement("div");
                    card.className = "kql-card";
                    card.innerHTML =
                        '<div class="kql-card-header"><span class="kql-card-name">' + esc(q.name) + '</span>' +
                        '<button class="btn btn-secondary btn-sm copy-chip" data-copy="' + esc(q.query).replace(/"/g, '&quot;') + '" title="Copy KQL">Copy</button></div>' +
                        '<div class="kql-card-desc">' + esc(q.description) + '</div>' +
                        '<div class="kql-code">' + esc(q.query) + '</div>';
                    grid.appendChild(card);
                });
            }
        })
        .catch(function (err) { alert("Request failed: " + err.message); })
        .finally(function () { btn.disabled = false; btn.textContent = "Generate Escalation"; });
    };

    window.copyEscalation = function () {
        var text = document.getElementById("escalation-output-pre").textContent;
        navigator.clipboard.writeText(text).then(function () {
            var btns = document.querySelectorAll(".escalation-actions .btn-primary");
            if (btns.length) { btns[0].textContent = "Copied!"; setTimeout(function () { btns[0].textContent = "Copy Escalation"; }, 2000); }
        });
    };

    window.enrichSenderIp = function () {
        var ip = (document.getElementById("ctx-sender-ip").value || "").trim();
        if (!ip) return;
        var btn = document.getElementById("btn-enrich-ip");
        btn.disabled = true; btn.textContent = "Enriching\u2026";
        fetch("/api/enrich-ip", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ip: ip}) })
        .then(function (resp) { return resp.json(); })
        .then(function (data) {
            if (data.error) { alert("Error: " + data.error); return; }
            var container = document.getElementById("sender-ip-results");
            container.style.display = "";
            var html = '<h4 style="margin:0 0 0.5rem;font-size:0.92rem;">Sender IP: ' + esc(data.ip) + '</h4>';
            if (data.vt) {
                var vt = data.vt;
                var vtBadge = vt.malicious > 0
                    ? '<span class="badge badge-malicious">' + vt.malicious + '/' + vt.total + ' malicious</span>'
                    : '<span class="badge badge-status-completed">' + vt.malicious + '/' + vt.total + ' engines</span>';
                html += '<div class="sender-ip-row"><span class="sender-ip-label">VirusTotal</span><span class="sender-ip-value">' + vtBadge;
                if (vt.as_owner) html += ' &middot; ' + esc(vt.as_owner);
                if (vt.country) html += ' (' + esc(vt.country) + ')';
                html += ' <a href="' + esc(data.vt_link) + '" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="margin-left:0.5rem;">View</a></span></div>';
            }
            if (data.abuseipdb) {
                var ab = data.abuseipdb;
                var abBadge = ab.abuse_confidence > 25
                    ? '<span class="badge badge-malicious">' + ab.abuse_confidence + '% abuse confidence</span>'
                    : '<span class="badge badge-status-completed">' + ab.abuse_confidence + '% abuse confidence</span>';
                html += '<div class="sender-ip-row"><span class="sender-ip-label">AbuseIPDB</span><span class="sender-ip-value">' + abBadge + ' &middot; ' + ab.total_reports + ' reports';
                if (ab.isp) html += ' &middot; ' + esc(ab.isp);
                if (ab.is_tor) html += ' <span class="flag flag-critical">TOR</span>';
                html += ' <a href="' + esc(data.abuseipdb_link) + '" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="margin-left:0.5rem;">View</a></span></div>';
            }
            if (!data.vt && !data.abuseipdb) html += '<p class="muted">No API keys configured for IP enrichment.</p>';
            container.innerHTML = html;
        })
        .catch(function (err) { alert("IP enrichment failed: " + err.message); })
        .finally(function () { btn.disabled = false; btn.textContent = "Enrich Sender IP"; });
    };

    /* ---- Delegated click handler for .copy-chip buttons ---- */
    document.addEventListener("click", function (e) {
        var btn = e.target.closest(".copy-chip");
        if (!btn) return;
        var text = btn.getAttribute("data-copy") || "";
        navigator.clipboard.writeText(text).then(function () {
            btn.textContent = "\u2713";
            setTimeout(function () { btn.textContent = "\uD83D\uDCCB"; }, 1200);
        });
    });
})();
</script>

{% else %}
{# ================================================================
   STATIC MODE — full results (existing template, unchanged)
   ================================================================ #}
{% set r = report %}
{% set cat = r.risk_category.name | lower %}

<!-- Score Banner -->
<section class="score-banner score-{{ cat }}">
    <div class="score-value">{{ r.risk_category.value }}</div>
    <div class="score-label">{{ "%.0f" | format(r.confidence) }}% Confidence</div>
    <div class="score-url">{{ r.url|defang }}</div>
</section>

<!-- Recommendation -->
<section class="recommendation rec-{{ cat }}">
    <p>{{ r.recommendation }}</p>
</section>

<!-- Action buttons at top -->
<div class="actions">
    <a href="/" class="btn btn-primary">New Scan</a>
    <button type="button" class="btn btn-secondary" id="copy-report-btn" onclick="copyReport()">Copy Report</button>
    {% if bulk_id %}
    <a href="/bulk?id={{ bulk_id }}" class="btn btn-secondary">Back to Bulk Scan</a>
    {% endif %}
</div>

<!-- Screenshot -->
<section class="card">
    <details open>
        <summary class="section-toggle">Page Screenshot</summary>
        <div class="section-body">
            {% if screenshot_filename %}
            <div class="screenshot-wrapper">
                <img src="/screenshots/{{ screenshot_filename }}" alt="Screenshot of {{ r.url }}" class="screenshot-img">
            </div>
            {% else %}
            <div class="screenshot-unavailable">
                <div class="screenshot-unavailable-icon">&#128247;</div>
                <p>Screenshot unavailable</p>
                <p class="muted">The site blocked the capture or the connection timed out.</p>
            </div>
            {% endif %}
        </div>
    </details>
</section>

<!-- Redirect Chain -->
{% if r.redirect_chain %}
<section class="card">
    <details open>
        <summary class="section-toggle">Redirect Chain</summary>
        <div class="section-body">
            <div class="redirect-chain">
                {% for hop in r.redirect_chain %}
                    <span class="redirect-hop">{{ hop|defang }}<button class="copy-chip" data-copy="{{ hop }}" title="Copy">&#128203;</button></span>
                    {% if not loop.last %}
                    <span class="redirect-arrow">&rarr;</span>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </details>
</section>
{% endif %}

<!-- URL Threat Feed Matches -->
{% if r.feed_results %}
<section class="card">
    <details open>
        <summary class="section-toggle">URL Threat Feed Results</summary>
        <div class="section-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>Feed</th>
                        <th>Match</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in r.feed_results|sort(attribute='display_order')|sort(attribute='matched', reverse=true) %}
                    <tr class="{% if f.matched %}feed-match{% endif %}">
                        <td>{{ f.feed_name }}</td>
                        <td>
                            {% if f.matched %}
                            <span class="badge badge-malicious">MATCH</span>
                            {% else %}
                            <span class="badge badge-status-skipped">Not Found</span>
                            {% endif %}
                        </td>
                        <td>{{ f.details or "—" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </details>
</section>
{% endif %}

<!-- File Download Analysis -->
{% if r.file_download and r.file_download.detected %}
<section class="card">
    <details open>
        <summary class="section-toggle">File Download Analysis</summary>
        <div class="section-body">

            {% if r.file_download.cloudflare_blocked %}
            <div class="cf-block-banner">
                <strong>&#9888; Cloudflare Phishing Interstitial Detected</strong>
                <p>Cloudflare has flagged this URL as suspected phishing. The file download is gated behind a Turnstile challenge that cannot be solved in an automated environment. Use the manual hash lookup below to complete the analysis.</p>
            </div>
            {% endif %}

            <div class="file-dl-stack">
                <!-- Filename header -->
                <div class="file-dl-filename">
                    {% if r.file_download.filename %}
                        <span class="file-dl-filename-label">File name:</span> {{ r.file_download.filename }}<button class="copy-chip" data-copy="{{ r.file_download.filename }}" title="Copy">&#128203;</button>
                    {% elif r.file_download.cloudflare_blocked %}
                        <span class="muted" style="font-weight:400;">Unknown filename &mdash; hidden behind Cloudflare interstitial</span>
                    {% else %}
                        <span class="muted" style="font-weight:400;">Unknown filename</span>
                    {% endif %}
                    {% if r.file_download.extension %}
                    <span class="flag flag-warning">{{ r.file_download.extension }}</span>
                    {% endif %}
                </div>

                <!-- Indented details: hash and VT -->
                <div class="file-dl-details">
                    {% if r.file_download.sha1 %}
                    <div class="file-dl-row">
                        <span class="file-dl-key">SHA-1</span>
                        <span class="file-dl-val">
                            <code class="hash-value">{{ r.file_download.sha1 }}</code><button class="copy-chip" data-copy="{{ r.file_download.sha1 }}" title="Copy">&#128203;</button>
                        </span>
                    </div>
                    {% endif %}
                    <div class="file-dl-row">
                        <span class="file-dl-key">SHA-256</span>
                        <span class="file-dl-val">
                            {% if r.file_download.sha256 %}
                            <code class="hash-value">{{ r.file_download.sha256 }}</code><button class="copy-chip" data-copy="{{ r.file_download.sha256 }}" title="Copy">&#128203;</button>
                            {% else %}
                            <span class="muted" id="hash-empty-msg">
                                {% if r.file_download.cloudflare_blocked %}
                                Could not retrieve file &mdash; use manual lookup below
                                {% else %}
                                Could not compute hash
                                {% endif %}
                            </span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="file-dl-row">
                        {% if r.file_download.vt_link %}
                        <a href="{{ r.file_download.vt_link }}" target="_blank" rel="noopener noreferrer" class="file-dl-key file-dl-key-link" id="vt-key-label">VirusTotal</a>
                        {% else %}
                        <span class="file-dl-key" id="vt-key-label">VirusTotal</span>
                        {% endif %}
                        <span class="file-dl-val" id="vt-result-cell">
                            {% if r.file_download.vt_total_engines > 0 %}
                                {% if r.file_download.vt_detections > 0 %}
                                <span class="badge badge-vt-malicious">{{ r.file_download.vt_detections }}/{{ r.file_download.vt_total_engines }} engines</span>
                                {% else %}
                                <span class="badge badge-vt-clean">0/{{ r.file_download.vt_total_engines }} engines</span>
                                {% endif %}
                                {% if r.file_download.threat_category %}
                                <span class="badge badge-threat-category">{{ r.file_download.threat_category }}</span>
                                {% endif %}
                                {% if r.file_download.popular_threat_label %}
                                <a href="https://www.google.com/search?q=%22{{ r.file_download.popular_threat_label | urlencode }}%22+malware+analysis" target="_blank" rel="noopener noreferrer" class="vt-threat-label" title="Search for {{ r.file_download.popular_threat_label }}">{{ r.file_download.popular_threat_label }}</a>
                                {% endif %}
                            {% elif r.file_download.vt_link %}
                                <span class="badge badge-vt-unknown">Not in database</span>
                            {% elif not r.file_download.sha256 %}
                                <span class="muted">Pending hash input</span>
                            {% else %}
                                <span class="muted">No API key configured</span>
                            {% endif %}
                        </span>
                    </div>
                </div>

                <!-- Secondary metadata row -->
                <div class="file-dl-meta">
                    <span class="file-dl-meta-item">
                        <span class="file-dl-meta-label">HOST:</span>
                        <span class="file-dl-meta-value">{{ r.file_download.hosting_domain }}</span>
                        {% if r.file_download.is_abused_host %}
                        <span class="flag flag-critical">Abused CDN</span>
                        {% endif %}
                    </span>
                    {% if r.file_download.content_type %}
                    <span class="file-dl-meta-item">
                        <span class="file-dl-meta-label">TYPE:</span>
                        <span class="file-dl-meta-value">{{ r.file_download.content_type }}</span>
                    </span>
                    {% endif %}
                    {% if r.file_download.size_bytes > 0 %}
                    <span class="file-dl-meta-item">
                        <span class="file-dl-meta-label">SIZE:</span>
                        <span class="file-dl-meta-value">{{ r.file_download.size_bytes | filesizeformat }}</span>
                    </span>
                    {% endif %}
                </div>
            </div>

            {% if not r.file_download.sha256 %}
            <div class="hash-input-section">
                <label for="manual-hash" class="hash-input-label">Manual Hash Lookup</label>
                <p class="muted" style="margin: 0.25rem 0 0.5rem;">Paste a SHA-256 hash from a sandbox or local analysis to query VirusTotal.</p>
                <div class="hash-input-row">
                    <input type="text" id="manual-hash" class="hash-input" placeholder="SHA-256 (64 hex characters)" maxlength="64" spellcheck="false" autocomplete="off">
                    <button type="button" id="hash-lookup-btn" class="btn btn-primary btn-sm" onclick="lookupHash()">Look Up</button>
                </div>
                <div id="hash-lookup-result" class="hash-lookup-result" style="display:none;"></div>
            </div>
            <script>
            async function lookupHash() {
                const input = document.getElementById('manual-hash');
                const btn = document.getElementById('hash-lookup-btn');
                const result = document.getElementById('hash-lookup-result');
                const vtCell = document.getElementById('vt-result-cell');
                const sha = input.value.trim().toLowerCase();

                if (!/^[a-f0-9]{64}$/.test(sha)) {
                    result.style.display = 'block';
                    result.className = 'hash-lookup-result hash-lookup-error';
                    result.textContent = 'Invalid hash. Must be 64 hex characters (SHA-256).';
                    return;
                }

                btn.disabled = true;
                btn.textContent = 'Looking up\u2026';
                result.style.display = 'block';
                result.className = 'hash-lookup-result';
                result.textContent = 'Querying VirusTotal\u2026';

                try {
                    const resp = await fetch('/api/hash-lookup', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({sha256: sha}),
                    });
                    const data = await resp.json();

                    if (data.error) {
                        result.className = 'hash-lookup-result hash-lookup-error';
                        result.textContent = data.error;
                    } else if (!data.found) {
                        result.className = 'hash-lookup-result hash-lookup-warn';
                        result.innerHTML = 'Hash not found in VirusTotal database. <a href="' + data.vt_link + '" target="_blank" rel="noopener noreferrer">View on VirusTotal</a>';
                    } else {
                        const det = data.detections;
                        const total = data.total;
                        const cls = det > 0 ? 'hash-lookup-danger' : 'hash-lookup-clean';
                        result.className = 'hash-lookup-result ' + cls;
                        result.innerHTML = '<strong>' + det + '/' + total + ' engines</strong> flagged this file'
                            + (data.malicious > 0 ? ' (' + data.malicious + ' malicious' + (data.suspicious > 0 ? ', ' + data.suspicious + ' suspicious' : '') + ')' : '')
                            + '. <a href="' + data.vt_link + '" target="_blank" rel="noopener noreferrer">View full report on VT</a>';

                        const emptyMsg = document.getElementById('hash-empty-msg');
                        if (emptyMsg) {
                            emptyMsg.outerHTML = '<code class="hash-value">' + sha + '</code>';
                        }
                        const vtKeyLabel = document.getElementById('vt-key-label');
                        if (vtKeyLabel && vtKeyLabel.tagName !== 'A') {
                            const link = document.createElement('a');
                            link.href = data.vt_link;
                            link.target = '_blank';
                            link.rel = 'noopener noreferrer';
                            link.className = 'file-dl-key file-dl-key-link';
                            link.id = 'vt-key-label';
                            link.textContent = 'VirusTotal';
                            vtKeyLabel.replaceWith(link);
                        }
                        if (vtCell) {
                            const badgeCls = det > 0 ? 'badge-vt-malicious' : 'badge-vt-clean';
                            let vtHtml = '<span class="badge ' + badgeCls + '">' + det + '/' + total + ' engines</span>';
                            if (data.threat_category) {
                                vtHtml += ' <span class="badge badge-threat-category">' + data.threat_category + '</span>';
                            }
                            if (data.popular_threat_label) {
                                vtHtml += ' <a href="https://www.google.com/search?q=%22' + encodeURIComponent(data.popular_threat_label) + '%22+malware+analysis" target="_blank" rel="noopener noreferrer" class="vt-threat-label" title="Search for ' + data.popular_threat_label + '">' + data.popular_threat_label + '</a>';
                            }
                            vtCell.innerHTML = vtHtml;
                        }
                    }
                } catch (err) {
                    result.className = 'hash-lookup-result hash-lookup-error';
                    result.textContent = 'Request failed: ' + err.message;
                }

                btn.disabled = false;
                btn.textContent = 'Look Up';
            }

            document.getElementById('manual-hash').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') lookupHash();
            });
            </script>
            {% endif %}

        </div>
    </details>
</section>
{% endif %}

<!-- Link Discovery -->
{% if r.discovered_links %}
<section class="card">
    <details open>
        <summary class="section-toggle">Link Discovery</summary>
        <div class="section-body">
            <p class="muted" style="margin-bottom: 0.75rem;">
                Auth-related links were clicked and inspected for hidden credential harvesters.
            </p>
            <table class="table">
                <thead>
                    <tr>
                        <th>Element</th>
                        <th>Destination</th>
                        <th>Flags</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dl in r.discovered_links %}
                    <tr class="{% if dl.has_credential_form %}feed-match{% endif %}">
                        <td>"{{ dl.element_text }}"</td>
                        <td class="url-cell">{{ dl.destination_url|defang }}<button class="copy-chip" data-copy="{{ dl.destination_url }}" title="Copy">&#128203;</button></td>
                        <td class="discovery-flags">
                            {% if dl.is_cross_domain %}
                            <span class="flag flag-warning">Cross-domain</span>
                            {% endif %}
                            {% if dl.has_credential_form %}
                            <span class="flag flag-critical">Credential form</span>
                            {% endif %}
                            {% if dl.brand_detected %}
                            <span class="flag flag-brand">Brand: {{ dl.brand_detected }}</span>
                            {% endif %}
                            {% if not dl.is_cross_domain and not dl.has_credential_form and not dl.brand_detected %}
                            <span class="muted">None</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </details>
</section>
{% endif %}

<!-- OSINT Links -->
{% if r.osint_links %}
<section class="card">
    <details open>
        <summary class="section-toggle">OSINT Links</summary>
        <div class="section-body">
            <div class="osint-grid">
                {% for link in r.osint_links %}
                <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="osint-link osint-{{ link.icon_class }}">
                    <span class="osint-name">{{ link.name }}</span>
                    <span class="osint-desc">{{ link.description }}</span>
                </a>
                {% endfor %}
            </div>
        </div>
    </details>
</section>
{% endif %}

<!-- Multi-Screenshots — only shown when a CTA button was actually clicked -->
{% if multi_screenshots and multi_screenshots.get('cta') %}
<section class="card">
    <details open>
        <summary class="section-toggle">Screenshots (Initial &amp; CTA Click)</summary>
        <div class="section-body">
            <div class="multi-screenshot-grid">
                {% if multi_screenshots.get('initial') %}
                <div class="multi-screenshot-item">
                    <div class="multi-screenshot-label">Initial Page</div>
                    {% if multi_screenshots.get('initial_url') %}
                    <div class="multi-screenshot-url">{{ multi_screenshots.initial_url|defang }}</div>
                    {% endif %}
                    <img src="/screenshots/{{ multi_screenshots.initial }}" alt="Initial page" class="screenshot-img">
                </div>
                {% endif %}
                <div class="multi-screenshot-item">
                    <div class="multi-screenshot-label label-cta">After Click: {{ multi_screenshots.get('cta_text', 'CTA') }}</div>
                    {% if multi_screenshots.get('cta_url') %}
                    <div class="multi-screenshot-url">{{ multi_screenshots.cta_url|defang }}</div>
                    {% endif %}
                    <img src="/screenshots/{{ multi_screenshots.cta }}" alt="After CTA click" class="screenshot-img">
                </div>
            </div>
        </div>
    </details>
</section>
{% endif %}

<!-- SOC Workflow: Alert Context + Escalation + KQL (phishing only, not downloads) -->
{% if cat not in ('malicious_download', 'suspicious_download') %}
<section class="card escalation-section">
    <details open>
        <summary class="section-toggle">SOC Workflow</summary>
        <div class="section-body">

            <!-- Email Metadata Input Panel -->
            <h4 style="margin:0 0 0.5rem;font-size:0.92rem;">Alert Context <span class="muted" style="font-weight:400;font-size:0.78rem;">(optional — fill in for a complete escalation)</span></h4>
            <div class="alert-context-panel">
                <div class="alert-context-grid">
                    <div class="alert-context-field">
                        <label class="alert-context-label">UPN / Email</label>
                        <input type="text" class="alert-context-input" id="ctx-upn" placeholder="user@contoso.com">
                    </div>
                    <div class="alert-context-field">
                        <label class="alert-context-label">Display Name</label>
                        <input type="text" class="alert-context-input" id="ctx-name" placeholder="John Doe">
                    </div>
                    <div class="alert-context-field">
                        <label class="alert-context-label">Subject</label>
                        <input type="text" class="alert-context-input" id="ctx-subject" placeholder="Email subject line">
                    </div>
                    <div class="alert-context-field">
                        <label class="alert-context-label">Network Message ID</label>
                        <input type="text" class="alert-context-input" id="ctx-msgid" placeholder="Message ID from alert">
                    </div>
                    <div class="alert-context-field">
                        <label class="alert-context-label">Sender</label>
                        <input type="text" class="alert-context-input" id="ctx-sender" placeholder="sender@malicious.com">
                    </div>
                    <div class="alert-context-field">
                        <label class="alert-context-label">Sender IP</label>
                        <input type="text" class="alert-context-input" id="ctx-sender-ip" placeholder="1.2.3.4">
                    </div>
                    <div class="alert-context-field full-width">
                        <label class="alert-context-label">Alert Name</label>
                        <input type="text" class="alert-context-input" id="ctx-alert-name" placeholder="e.g. Phishing URL Click">
                    </div>
                </div>
                <div class="alert-context-actions">
                    <button type="button" class="btn btn-primary btn-sm" id="btn-generate-escalation" onclick="generateEscalation()">Generate Escalation</button>
                    <button type="button" class="btn btn-secondary btn-sm" id="btn-enrich-ip" onclick="enrichSenderIp()" style="display:none;">Enrich Sender IP</button>
                </div>
            </div>

            <!-- Sender IP Enrichment Results (hidden until enriched) -->
            <div id="sender-ip-results" class="sender-ip-results" style="display:none;"></div>

            <!-- KQL Queries (populated after generate) -->
            <div id="kql-section" style="display:none;margin-top:1.25rem;">
                <h4 style="margin:0 0 0.5rem;font-size:0.92rem;">KQL Queries</h4>
                <div class="kql-grid" id="kql-grid"></div>
            </div>

            <!-- Escalation Output (populated after generate) -->
            <div id="escalation-section" style="display:none;margin-top:1.25rem;">
                <h4 style="margin:0 0 0.5rem;font-size:0.92rem;">Escalation</h4>
                <div class="escalation-output">
                    <pre id="escalation-output-pre"></pre>
                </div>
                <div class="escalation-actions">
                    <button type="button" class="btn btn-primary btn-sm" onclick="copyEscalation()">Copy Escalation</button>
                </div>
            </div>

        </div>
    </details>
</section>
{% endif %}

<!-- Analyzer Breakdown -->
<section class="card">
    <details>
        <summary class="section-toggle">Analyzer Breakdown</summary>
        <div class="section-body">
            <table class="table table--fixed">
                <colgroup>
                    <col style="width:55%">
                    <col style="width:15%">
                    <col style="width:15%">
                    <col style="width:15%">
                </colgroup>
                <thead>
                    <tr>
                        <th>Analyzer</th>
                        <th>Status</th>
                        <th>Score</th>
                        <th>Weight</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in r.analyzer_results %}
                    <tr>
                        <td>
                            <details>
                                <summary>{{ a.analyzer_name }}</summary>
                                {% if a.findings %}
                                <ul class="findings-list">
                                    {% for f in a.findings | sort_by_severity %}
                                    <li onclick="this.classList.toggle('expanded')">
                                        <span class="severity severity-{{ f.severity }}">{{ f.severity }}</span>
                                        {{ f.description }} (+{{ "%.0f" | format(f.score_contribution) }})
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% elif a.error_message %}
                                <p class="error-message">{{ a.error_message }}</p>
                                {% else %}
                                <p class="muted">No findings.</p>
                                {% endif %}
                            </details>
                        </td>
                        <td>
                            <span class="badge badge-status-{{ a.status.value | lower }}">
                                {{ a.status.value }}
                            </span>
                        </td>
                        <td>{{ "%.1f" | format(a.score) }}</td>
                        <td>{{ "%.0f" | format(a.max_weight) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </details>
</section>

<!-- Metadata -->
<section class="card">
    <details>
        <summary class="section-toggle">Scan Metadata</summary>
        <div class="section-body meta-content">
            <p><strong>Scan ID:</strong> {{ scan_id }}</p>
            <p><strong>Timestamp:</strong> {{ r.timestamp }}</p>
            {% if ip %}<p><strong>Resolved IP:</strong> {{ ip }}</p>{% endif %}
            <p><strong>Domain:</strong> {{ domain }}</p>
        </div>
    </details>
</section>

<script>
(function () {
    "use strict";

    var _reportData = {{ report_json|safe }};

    function defang(url) {
        if (!url) return "";
        var s = url;
        s = s.replace(/^https:\/\//i, "hxxps://");
        s = s.replace(/^http:\/\//i, "hxxp://");
        s = s.replace(/^ftp:\/\//i, "fxp://");
        var match = s.match(/^(hxxps?:\/\/|fxp:\/\/)/i);
        if (match) {
            var after = s.substring(match[0].length);
            var slashIdx = after.indexOf("/");
            if (slashIdx === -1) {
                s = match[0] + after.replace(/\./g, "[.]");
            } else {
                var domain = after.substring(0, slashIdx);
                var path = after.substring(slashIdx);
                s = match[0] + domain.replace(/\./g, "[.]") + path;
            }
        } else {
            var slashIdx = s.indexOf("/");
            if (slashIdx === -1) {
                s = s.replace(/\./g, "[.]");
            } else {
                var domain = s.substring(0, slashIdx);
                var path = s.substring(slashIdx);
                s = domain.replace(/\./g, "[.]") + path;
            }
        }
        return s;
    }

    window.copyReport = function () {
        var d = _reportData;
        var lines = [];
        lines.push("=== IRIS Scan Report ===");
        lines.push("URL (defanged): " + d.defanged_url);
        lines.push("Classification: " + d.risk_category + " (" + d.confidence.toFixed(0) + "% confidence)");
        lines.push("Scanned: " + d.timestamp);
        if (d.ip) lines.push("Resolved IP: " + defang(d.ip));
        lines.push("Domain: " + d.domain);
        lines.push("");
        lines.push("--- Recommendation ---");
        lines.push(d.recommendation);

        if (d.feed_results && d.feed_results.length) {
            lines.push("");
            lines.push("--- Threat Feed Results ---");
            d.feed_results.forEach(function (f) {
                var tag = f.matched ? "[MATCH]" : "[CLEAR]";
                lines.push(tag + " " + f.feed_name + ": " + (f.details || "No details"));
            });
        }

        if (d.redirect_chain && d.redirect_chain.length) {
            lines.push("");
            lines.push("--- Redirect Chain (" + d.redirect_chain.length + " hops) ---");
            lines.push(d.redirect_chain.map(function (h) { return defang(h); }).join(" -> "));
        }

        if (d.findings && d.findings.length) {
            lines.push("");
            lines.push("--- Key Findings ---");
            var sevOrder = {critical: 0, high: 1, medium: 2, low: 3, info: 4};
            var sorted = d.findings.slice().sort(function (a, b) {
                return (sevOrder[a.severity] || 5) - (sevOrder[b.severity] || 5);
            });
            sorted.forEach(function (f) {
                lines.push("[" + f.severity.toUpperCase() + "] " + f.description + " (+" + Math.round(f.score) + ")");
            });
        }

        if (d.file_download) {
            lines.push("");
            lines.push("--- File Download ---");
            if (d.file_download.filename) lines.push("Filename: " + d.file_download.filename);
            if (d.file_download.sha1) lines.push("SHA-1: " + d.file_download.sha1);
            if (d.file_download.sha256) lines.push("SHA-256: " + d.file_download.sha256);
            if (d.file_download.vt_total_engines > 0) {
                var vtLine = "VirusTotal: " + d.file_download.vt_detections + "/" + d.file_download.vt_total_engines + " engines";
                if (d.file_download.popular_threat_label) vtLine += " (" + d.file_download.popular_threat_label + ")";
                lines.push(vtLine);
            }
        }

        lines.push("");
        lines.push("=== End IRIS Report ===");

        navigator.clipboard.writeText(lines.join("\n")).then(function () {
            var btn = document.getElementById("copy-report-btn");
            btn.textContent = "Copied!";
            setTimeout(function () { btn.textContent = "Copy Report"; }, 2000);
        });
    };

    /* ---- Delegated click handler for .copy-chip buttons ---- */
    document.addEventListener("click", function (e) {
        var btn = e.target.closest(".copy-chip");
        if (!btn) return;
        var text = btn.getAttribute("data-copy") || "";
        navigator.clipboard.writeText(text).then(function () {
            btn.textContent = "\u2713";
            setTimeout(function () { btn.textContent = "\uD83D\uDCCB"; }, 1200);
        });
    });

    /* ---- Show Enrich IP button when sender IP is entered ---- */
    var senderIpInput = document.getElementById("ctx-sender-ip");
    if (senderIpInput) {
        senderIpInput.addEventListener("input", function () {
            var btn = document.getElementById("btn-enrich-ip");
            btn.style.display = this.value.trim() ? "" : "none";
        });
    }

    /* ---- Generate Escalation ---- */
    window.generateEscalation = function () {
        var scanId = "{{ scan_id }}";
        var btn = document.getElementById("btn-generate-escalation");
        btn.disabled = true;
        btn.textContent = "Generating\u2026";

        var alertCtx = {
            upn: (document.getElementById("ctx-upn").value || "").trim(),
            name: (document.getElementById("ctx-name").value || "").trim(),
            subject: (document.getElementById("ctx-subject").value || "").trim(),
            network_message_id: (document.getElementById("ctx-msgid").value || "").trim(),
            sender: (document.getElementById("ctx-sender").value || "").trim(),
            sender_ip: (document.getElementById("ctx-sender-ip").value || "").trim(),
            alert_name: (document.getElementById("ctx-alert-name").value || "").trim(),
        };

        /* Only send non-empty fields */
        var hasContext = false;
        Object.keys(alertCtx).forEach(function (k) {
            if (!alertCtx[k]) delete alertCtx[k];
            else hasContext = true;
        });

        fetch("/api/escalation/" + scanId, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({alert_context: hasContext ? alertCtx : null}),
        })
        .then(function (resp) { return resp.json(); })
        .then(function (data) {
            if (data.error) {
                alert("Error: " + data.error);
                return;
            }

            /* Render escalation markdown */
            var escSection = document.getElementById("escalation-section");
            escSection.style.display = "";
            document.getElementById("escalation-output-pre").textContent = data.escalation_md;

            /* Render KQL queries */
            if (data.kql_queries && data.kql_queries.length) {
                var kqlSection = document.getElementById("kql-section");
                kqlSection.style.display = "";
                var grid = document.getElementById("kql-grid");
                grid.innerHTML = "";

                data.kql_queries.forEach(function (q) {
                    var card = document.createElement("div");
                    card.className = "kql-card";
                    card.innerHTML =
                        '<div class="kql-card-header">' +
                        '  <span class="kql-card-name">' + esc(q.name) + '</span>' +
                        '  <button class="btn btn-secondary btn-sm copy-chip" data-copy="' + esc(q.query).replace(/"/g, '&quot;') + '" title="Copy KQL">Copy</button>' +
                        '</div>' +
                        '<div class="kql-card-desc">' + esc(q.description) + '</div>' +
                        '<div class="kql-code">' + esc(q.query) + '</div>';
                    grid.appendChild(card);
                });
            }
        })
        .catch(function (err) {
            alert("Request failed: " + err.message);
        })
        .finally(function () {
            btn.disabled = false;
            btn.textContent = "Generate Escalation";
        });
    };

    function esc(s) {
        var el = document.createElement("span");
        el.textContent = s || "";
        return el.innerHTML;
    }

    /* ---- Copy Escalation ---- */
    window.copyEscalation = function () {
        var text = document.getElementById("escalation-output-pre").textContent;
        navigator.clipboard.writeText(text).then(function () {
            var btns = document.querySelectorAll(".escalation-actions .btn-primary");
            if (btns.length) {
                btns[0].textContent = "Copied!";
                setTimeout(function () { btns[0].textContent = "Copy Escalation"; }, 2000);
            }
        });
    };

    /* ---- Sender IP Enrichment ---- */
    window.enrichSenderIp = function () {
        var ip = (document.getElementById("ctx-sender-ip").value || "").trim();
        if (!ip) return;

        var btn = document.getElementById("btn-enrich-ip");
        btn.disabled = true;
        btn.textContent = "Enriching\u2026";

        fetch("/api/enrich-ip", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ip: ip}),
        })
        .then(function (resp) { return resp.json(); })
        .then(function (data) {
            if (data.error) {
                alert("Error: " + data.error);
                return;
            }

            var container = document.getElementById("sender-ip-results");
            container.style.display = "";
            var html = '<h4 style="margin:0 0 0.5rem;font-size:0.92rem;">Sender IP: ' + esc(data.ip) + '</h4>';

            /* VirusTotal results */
            if (data.vt) {
                var vt = data.vt;
                var vtBadge = vt.malicious > 0
                    ? '<span class="badge badge-malicious">' + vt.malicious + '/' + vt.total + ' malicious</span>'
                    : '<span class="badge badge-status-completed">' + vt.malicious + '/' + vt.total + ' engines</span>';
                html += '<div class="sender-ip-row">' +
                    '<span class="sender-ip-label">VirusTotal</span>' +
                    '<span class="sender-ip-value">' + vtBadge;
                if (vt.as_owner) html += ' &middot; ' + esc(vt.as_owner);
                if (vt.country) html += ' (' + esc(vt.country) + ')';
                html += ' <a href="' + esc(data.vt_link) + '" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="margin-left:0.5rem;">View</a>';
                html += '</span></div>';
            }

            /* AbuseIPDB results */
            if (data.abuseipdb) {
                var ab = data.abuseipdb;
                var abBadge = ab.abuse_confidence > 25
                    ? '<span class="badge badge-malicious">' + ab.abuse_confidence + '% abuse confidence</span>'
                    : '<span class="badge badge-status-completed">' + ab.abuse_confidence + '% abuse confidence</span>';
                html += '<div class="sender-ip-row">' +
                    '<span class="sender-ip-label">AbuseIPDB</span>' +
                    '<span class="sender-ip-value">' + abBadge +
                    ' &middot; ' + ab.total_reports + ' reports';
                if (ab.isp) html += ' &middot; ' + esc(ab.isp);
                if (ab.is_tor) html += ' <span class="flag flag-critical">TOR</span>';
                html += ' <a href="' + esc(data.abuseipdb_link) + '" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="margin-left:0.5rem;">View</a>';
                html += '</span></div>';
            }

            if (!data.vt && !data.abuseipdb) {
                html += '<p class="muted">No API keys configured for IP enrichment.</p>';
            }

            container.innerHTML = html;
        })
        .catch(function (err) {
            alert("IP enrichment failed: " + err.message);
        })
        .finally(function () {
            btn.disabled = false;
            btn.textContent = "Enrich Sender IP";
        });
    };
})();
</script>
{% endif %}

{% endblock %}
